<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio & Watchlist | ETF Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .portfolio-card { 
            border-left: 4px solid #28a745; 
            transition: transform 0.2s;
        }
        .watchlist-card { 
            border-left: 4px solid #007bff; 
        }
        .portfolio-card:hover, .watchlist-card:hover { transform: translateY(-2px); }
        .gain { color: #28a745; }
        .loss { color: #dc3545; }
        .neutral { color: #6c757d; }
        .allocation-chart { max-height: 300px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <span>‚Üê Back to Dashboard</span>
            </a>
            <h4 class="text-white mb-0">üíº Portfolio & Watchlist</h4>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Portfolio Summary -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card portfolio-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Value</h5>
                        <h2 class="text-success" id="totalValue">$0.00</h2>
                        <small class="text-muted">Portfolio Value</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card portfolio-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Gain/Loss</h5>
                        <h2 id="totalGainLoss">$0.00</h2>
                        <small class="text-muted" id="totalGainLossPercent">0.00%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card watchlist-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Watchlist</h5>
                        <h2 class="text-primary" id="watchlistCount">0</h2>
                        <small class="text-muted">ETFs Tracked</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Alerts</h5>
                        <h2 class="text-warning" id="alertCount">0</h2>
                        <small class="text-muted">Active Alerts</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Management Tabs -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="portfolioTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="portfolio-tab" data-bs-toggle="tab" data-bs-target="#portfolio" type="button" role="tab">
                            üíº Portfolio Holdings
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="watchlist-tab" data-bs-toggle="tab" data-bs-target="#watchlist" type="button" role="tab">
                            üëÅÔ∏è Watchlist
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
                            üìà Performance
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button" role="tab">
                            üîî Alerts
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="portfolioTabContent">
                    <!-- Portfolio Holdings Tab -->
                    <div class="tab-pane fade show active" id="portfolio" role="tabpanel">
                        <div class="row mb-3">
                            <div class="col-md-9">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Portfolio Holdings</h5>
                                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addHoldingModal">
                                            + Add Holding
                                        </button>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover mb-0">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>ETF</th>
                                                        <th>Shares</th>
                                                        <th>Avg Cost</th>
                                                        <th>Current Price</th>
                                                        <th>Market Value</th>
                                                        <th>Gain/Loss</th>
                                                        <th>%</th>
                                                        <th>RSI</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="portfolioHoldings">
                                                    <tr>
                                                        <td colspan="9" class="text-center text-muted py-4">
                                                            No holdings in portfolio. Click "Add Holding" to get started.
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Allocation</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="allocationChart" class="allocation-chart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Watchlist Tab -->
                    <div class="tab-pane fade" id="watchlist" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Watchlist</h5>
                                <div>
                                    <button class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addToWatchlistModal">
                                        + Add to Watchlist
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshWatchlist()">
                                        üîÑ Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ETF</th>
                                                <th>Name</th>
                                                <th>Current Price</th>
                                                <th>RSI</th>
                                                <th>Signal</th>
                                                <th>Volume</th>
                                                <th>Last Updated</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="watchlistItems">
                                            <tr>
                                                <td colspan="8" class="text-center text-muted py-4">
                                                    No ETFs in watchlist. Click "Add to Watchlist" to start tracking.
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Tab -->
                    <div class="tab-pane fade" id="performance" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5 class="mb-0">Portfolio Performance</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="performanceChart" style="min-height: 400px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Performance Metrics</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-12 mb-3">
                                                <h4 id="portfolioReturn" class="text-success">+0.00%</h4>
                                                <small class="text-muted">Total Return</small>
                                            </div>
                                            <div class="col-6">
                                                <h5 id="dayReturn">+0.00%</h5>
                                                <small class="text-muted">1 Day</small>
                                            </div>
                                            <div class="col-6">
                                                <h5 id="weekReturn">+0.00%</h5>
                                                <small class="text-muted">1 Week</small>
                                            </div>
                                            <div class="col-6 mt-2">
                                                <h5 id="monthReturn">+0.00%</h5>
                                                <small class="text-muted">1 Month</small>
                                            </div>
                                            <div class="col-6 mt-2">
                                                <h5 id="yearReturn">+0.00%</h5>
                                                <small class="text-muted">1 Year</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Top Performers</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="topPerformers">
                                            <div class="text-center text-muted">No data available</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alerts Tab -->
                    <div class="tab-pane fade" id="alerts" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Active Alerts</h5>
                                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createAlertModal">
                                            + Create Alert
                                        </button>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover mb-0">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>ETF</th>
                                                        <th>Alert Type</th>
                                                        <th>Condition</th>
                                                        <th>Current Value</th>
                                                        <th>Status</th>
                                                        <th>Created</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="alertsList">
                                                    <tr>
                                                        <td colspan="7" class="text-center text-muted py-4">
                                                            No alerts configured. Click "Create Alert" to set up notifications.
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Recent Notifications</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="recentNotifications">
                                            <div class="text-center text-muted">No recent notifications</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Holding Modal -->
    <div class="modal fade" id="addHoldingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Portfolio Holding</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addHoldingForm">
                        <div class="mb-3">
                            <label class="form-label">ETF Ticker</label>
                            <input type="text" class="form-control" id="holdingTicker" placeholder="e.g., SPY" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Number of Shares</label>
                            <input type="number" class="form-control" id="holdingShares" step="0.001" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Average Cost per Share</label>
                            <input type="number" class="form-control" id="holdingCost" step="0.01" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Purchase Date (Optional)</label>
                            <input type="date" class="form-control" id="holdingDate">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addHolding()">Add Holding</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add to Watchlist Modal -->
    <div class="modal fade" id="addToWatchlistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add to Watchlist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addWatchlistForm">
                        <div class="mb-3">
                            <label class="form-label">ETF Ticker</label>
                            <input type="text" class="form-control" id="watchlistTicker" placeholder="e.g., QQQ" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="watchlistNotes" rows="3" placeholder="Why are you tracking this ETF?"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addToWatchlist()">Add to Watchlist</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Alert Modal -->
    <div class="modal fade" id="createAlertModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Alert</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createAlertForm">
                        <div class="mb-3">
                            <label class="form-label">ETF Ticker</label>
                            <input type="text" class="form-control" id="alertTicker" placeholder="e.g., VTI" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Alert Type</label>
                            <select class="form-select" id="alertType" required>
                                <option value="">Select alert type</option>
                                <option value="price_above">Price Above</option>
                                <option value="price_below">Price Below</option>
                                <option value="rsi_above">RSI Above</option>
                                <option value="rsi_below">RSI Below</option>
                                <option value="volume_above">Volume Above</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Alert Value</label>
                            <input type="number" class="form-control" id="alertValue" step="0.01" required>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="alertEmail">
                            <label class="form-check-label" for="alertEmail">
                                Send email notification
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createAlert()">Create Alert</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let portfolioData = [];
        let watchlistData = [];
        let alertsData = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadPortfolioData();
            loadWatchlistData();
            loadAlertsData();
            updateSummary();
        });

        function loadPortfolioData() {
            // Load from localStorage (in real app, would load from backend)
            const saved = localStorage.getItem('etfPortfolio');
            portfolioData = saved ? JSON.parse(saved) : [];
            updatePortfolioDisplay();
            updateAllocationChart();
        }

        function loadWatchlistData() {
            const saved = localStorage.getItem('etfWatchlist');
            watchlistData = saved ? JSON.parse(saved) : [];
            updateWatchlistDisplay();
        }

        function loadAlertsData() {
            const saved = localStorage.getItem('etfAlerts');
            alertsData = saved ? JSON.parse(saved) : [];
            updateAlertsDisplay();
        }

        function saveData() {
            localStorage.setItem('etfPortfolio', JSON.stringify(portfolioData));
            localStorage.setItem('etfWatchlist', JSON.stringify(watchlistData));
            localStorage.setItem('etfAlerts', JSON.stringify(alertsData));
        }

        function updateSummary() {
            const totalValue = portfolioData.reduce((sum, holding) => {
                return sum + (holding.shares * (holding.currentPrice || holding.avgCost));
            }, 0);

            const totalCost = portfolioData.reduce((sum, holding) => {
                return sum + (holding.shares * holding.avgCost);
            }, 0);

            const totalGainLoss = totalValue - totalCost;
            const totalGainLossPercent = totalCost > 0 ? (totalGainLoss / totalCost) * 100 : 0;

            document.getElementById('totalValue').textContent = `${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('totalGainLoss').textContent = `${totalGainLoss >= 0 ? '+' : ''}${totalGainLoss.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('totalGainLoss').className = totalGainLoss >= 0 ? 'gain' : 'loss';
            document.getElementById('totalGainLossPercent').textContent = `${totalGainLossPercent >= 0 ? '+' : ''}${totalGainLossPercent.toFixed(2)}%`;
            
            document.getElementById('watchlistCount').textContent = watchlistData.length;
            document.getElementById('alertCount').textContent = alertsData.filter(alert => alert.active).length;
        }

        function updatePortfolioDisplay() {
            const tbody = document.getElementById('portfolioHoldings');
            tbody.innerHTML = '';

            if (portfolioData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            No holdings in portfolio. Click "Add Holding" to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            portfolioData.forEach((holding, index) => {
                const currentPrice = holding.currentPrice || holding.avgCost; // Simulate current price
                const marketValue = holding.shares * currentPrice;
                const costBasis = holding.shares * holding.avgCost;
                const gainLoss = marketValue - costBasis;
                const gainLossPercent = (gainLoss / costBasis) * 100;
                const rsi = holding.rsi || (Math.random() * 100); // Simulate RSI

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${holding.ticker}</strong></td>
                    <td>${holding.shares.toLocaleString()}</td>
                    <td>${holding.avgCost.toFixed(2)}</td>
                    <td>${currentPrice.toFixed(2)}</td>
                    <td>${marketValue.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="${gainLoss >= 0 ? 'gain' : 'loss'}">${gainLoss >= 0 ? '+' : ''}${gainLoss.toFixed(2)}</td>
                    <td class="${gainLoss >= 0 ? 'gain' : 'loss'}">${gainLoss >= 0 ? '+' : ''}${gainLossPercent.toFixed(2)}%</td>
                    <td><span class="badge ${getRSIBadgeClass(rsi)}">${rsi.toFixed(1)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="window.open('/etf/${holding.ticker}', '_blank')">View</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeHolding(${index})">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateWatchlistDisplay() {
            const tbody = document.getElementById('watchlistItems');
            tbody.innerHTML = '';

            if (watchlistData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            No ETFs in watchlist. Click "Add to Watchlist" to start tracking.
                        </td>
                    </tr>
                `;
                return;
            }

            watchlistData.forEach((item, index) => {
                const rsi = item.rsi || (Math.random() * 100);
                const price = item.currentPrice || (Math.random() * 500 + 50);
                const signal = getSignalFromRSI(rsi);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.ticker}</strong></td>
                    <td>${item.name || item.ticker}</td>
                    <td>${price.toFixed(2)}</td>
                    <td><span class="badge ${getRSIBadgeClass(rsi)}">${rsi.toFixed(1)}</span></td>
                    <td><span class="badge ${signal.class}">${signal.text}</span></td>
                    <td>${formatVolume(Math.floor(Math.random() * 10000000))}</td>
                    <td>${new Date().toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="window.open('/etf/${item.ticker}', '_blank')">View</button>
                        <button class="btn btn-sm btn-outline-success me-1" onclick="addToPortfolioFromWatchlist('${item.ticker}')">Add to Portfolio</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromWatchlist(${index})">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAlertsDisplay() {
            const tbody = document.getElementById('alertsList');
            tbody.innerHTML = '';

            if (alertsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            No alerts configured. Click "Create Alert" to set up notifications.
                        </td>
                    </tr>
                `;
                return;
            }

            alertsData.forEach((alert, index) => {
                const currentValue = getCurrentValue(alert.ticker, alert.type);
                const status = checkAlertStatus(alert, currentValue);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${alert.ticker}</strong></td>
                    <td>${formatAlertType(alert.type)}</td>
                    <td>${formatCondition(alert.type, alert.value)}</td>
                    <td>${formatCurrentValue(alert.type, currentValue)}</td>
                    <td><span class="badge ${status.class}">${status.text}</span></td>
                    <td>${new Date(alert.created).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-${alert.active ? 'warning' : 'success'}" onclick="toggleAlert(${index})">
                            ${alert.active ? 'Pause' : 'Activate'}
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="removeAlert(${index})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAllocationChart() {
            if (portfolioData.length === 0) {
                document.getElementById('allocationChart').innerHTML = '<div class="text-center text-muted">No data</div>';
                return;
            }

            const totalValue = portfolioData.reduce((sum, holding) => {
                return sum + (holding.shares * (holding.currentPrice || holding.avgCost));
            }, 0);

            const chartData = portfolioData.map(holding => {
                const value = holding.shares * (holding.currentPrice || holding.avgCost);
                return {
                    ticker: holding.ticker,
                    value: value,
                    percentage: (value / totalValue) * 100
                };
            });

            const spec = {
                $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
                width: 200,
                height: 200,
                data: { values: chartData },
                mark: { type: 'arc', innerRadius: 50 },
                encoding: {
                    theta: { field: 'percentage', type: 'quantitative' },
                    color: { field: 'ticker', type: 'nominal' },
                    tooltip: [
                        { field: 'ticker', type: 'nominal' },
                        { field: 'percentage', type: 'quantitative', format: '.1f', title: 'Percentage (%)' },
                        { field: 'value', type: 'quantitative', format: '$.2f', title: 'Value' }
                    ]
                }
            };

            vegaEmbed('#allocationChart', spec, { theme: 'quartz', actions: false });
        }

        // Modal functions
        function addHolding() {
            const ticker = document.getElementById('holdingTicker').value.toUpperCase();
            const shares = parseFloat(document.getElementById('holdingShares').value);
            const avgCost = parseFloat(document.getElementById('holdingCost').value);
            const date = document.getElementById('holdingDate').value;

            if (!ticker || !shares || !avgCost) {
                alert('Please fill in all required fields');
                return;
            }

            const holding = {
                ticker: ticker,
                shares: shares,
                avgCost: avgCost,
                purchaseDate: date || new Date().toISOString().split('T')[0],
                currentPrice: avgCost * (1 + (Math.random() - 0.5) * 0.2) // Simulate price change
            };

            portfolioData.push(holding);
            saveData();
            updatePortfolioDisplay();
            updateAllocationChart();
            updateSummary();

            // Close modal and reset form
            bootstrap.Modal.getInstance(document.getElementById('addHoldingModal')).hide();
            document.getElementById('addHoldingForm').reset();
        }

        function addToWatchlist() {
            const ticker = document.getElementById('watchlistTicker').value.toUpperCase();
            const notes = document.getElementById('watchlistNotes').value;

            if (!ticker) {
                alert('Please enter a ticker symbol');
                return;
            }

            if (watchlistData.some(item => item.ticker === ticker)) {
                alert('This ETF is already in your watchlist');
                return;
            }

            const watchlistItem = {
                ticker: ticker,
                notes: notes,
                added: new Date().toISOString()
            };

            watchlistData.push(watchlistItem);
            saveData();
            updateWatchlistDisplay();
            updateSummary();

            bootstrap.Modal.getInstance(document.getElementById('addToWatchlistModal')).hide();
            document.getElementById('addWatchlistForm').reset();
        }

        function createAlert() {
            const ticker = document.getElementById('alertTicker').value.toUpperCase();
            const type = document.getElementById('alertType').value;
            const value = parseFloat(document.getElementById('alertValue').value);
            const email = document.getElementById('alertEmail').checked;

            if (!ticker || !type || !value) {
                alert('Please fill in all required fields');
                return;
            }

            const alert = {
                ticker: ticker,
                type: type,
                value: value,
                email: email,
                active: true,
                created: new Date().toISOString()
            };

            alertsData.push(alert);
            saveData();
            updateAlertsDisplay();
            updateSummary();

            bootstrap.Modal.getInstance(document.getElementById('createAlertModal')).hide();
            document.getElementById('createAlertForm').reset();
        }

        // Helper functions
        function getRSIBadgeClass(rsi) {
            if (rsi < 30) return 'bg-success';
            if (rsi > 70) return 'bg-danger';
            return 'bg-primary';
        }

        function getSignalFromRSI(rsi) {
            if (rsi < 30) return { text: 'BUY', class: 'bg-success' };
            if (rsi > 70) return { text: 'SELL', class: 'bg-danger' };
            return { text: 'HOLD', class: 'bg-secondary' };
        }

        function formatVolume(volume) {
            if (volume >= 1000000) return (volume / 1000000).toFixed(1) + 'M';
            if (volume >= 1000) return (volume / 1000).toFixed(1) + 'K';
            return volume.toLocaleString();
        }

        function removeHolding(index) {
            if (confirm('Are you sure you want to remove this holding?')) {
                portfolioData.splice(index, 1);
                saveData();
                updatePortfolioDisplay();
                updateAllocationChart();
                updateSummary();
            }
        }

        function removeFromWatchlist(index) {
            if (confirm('Remove this ETF from your watchlist?')) {
                watchlistData.splice(index, 1);
                saveData();
                updateWatchlistDisplay();
                updateSummary();
            }
        }

        function removeAlert(index) {
            if (confirm('Delete this alert?')) {
                alertsData.splice(index, 1);
                saveData();
                updateAlertsDisplay();
                updateSummary();
            }
        }

        function toggleAlert(index) {
            alertsData[index].active = !alertsData[index].active;
            saveData();
            updateAlertsDisplay();
            updateSummary();
        }

        function addToPortfolioFromWatchlist(ticker) {
            // Pre-fill the add holding modal
            document.getElementById('holdingTicker').value = ticker;
            bootstrap.Modal.getInstance(document.getElementById('addToWatchlistModal')).hide();
            new bootstrap.Modal(document.getElementById('addHoldingModal')).show();
        }

        function refreshWatchlist() {
            // In real app, would fetch fresh data from API
            updateWatchlistDisplay();
        }

        // Placeholder functions for alert management
        function getCurrentValue(ticker, type) {
            // In real app, would fetch from API
            switch(type) {
                case 'price_above':
                case 'price_below':
                    return Math.random() * 500 + 50;
                case 'rsi_above':
                case 'rsi_below':
                    return Math.random() * 100;
                case 'volume_above':
                    return Math.floor(Math.random() * 10000000);
                default:
                    return 0;
            }
        }

        function checkAlertStatus(alert, currentValue) {
            if (!alert.active) return { text: 'Paused', class: 'bg-secondary' };
            
            let triggered = false;
            switch(alert.type) {
                case 'price_above':
                case 'rsi_above':
                case 'volume_above':
                    triggered = currentValue > alert.value;
                    break;
                case 'price_below':
                case 'rsi_below':
                    triggered = currentValue < alert.value;
                    break;
            }
            
            return triggered ? 
                { text: 'Triggered', class: 'bg-warning' } : 
                { text: 'Active', class: 'bg-success' };
        }

        function formatAlertType(type) {
            const types = {
                'price_above': 'Price Above',
                'price_below': 'Price Below',
                'rsi_above': 'RSI Above',
                'rsi_below': 'RSI Below',
                'volume_above': 'Volume Above'
            };
            return types[type] || type;
        }

        function formatCondition(type, value) {
            if (type.includes('price')) return `${value.toFixed(2)}`;
            if (type.includes('volume')) return value.toLocaleString();
            return value.toString();
        }

        function formatCurrentValue(type, value) {
            if (type.includes('price')) return `${value.toFixed(2)}`;
            if (type.includes('volume')) return formatVolume(value);
            return value.toFixed(1);
        }
    </script>
</body>
</html>